#!/usr/bin/env bash

RB_RELEASE="20120920"

# Env

[ -n "$RB_RUBIES_DIR" ]   || RB_RUBIES_DIR="$HOME/.rubies"
[ -n "$RB_VERSION_FILE" ] || RB_VERSION_FILE=".ruby-version"

_rb_activate () {

  # locals

  local VERSION SOURCE COMMAND
  local MSG PWD_AND_PARENTS_SEARCH_RESULT

  # utility methods

  warn () { echo -e "$1" >&2; }
  info () { warn "$1"; }

  set_env_var () { export $1="$2"; }
  unset_env_var () { unset $1; }

  path_remove ()  {
    set_env_var PATH "`echo $PATH | awk -v RS=: -v ORS=: '$0 != "'$1'"' | sed 's/:$//'`";
  }

  path_append ()  {
    path_remove $1; set_env_var PATH "$PATH:$1";
  }

  path_prepend () {
    path_remove $1; set_env_var PATH "$1:$PATH";
  }

  search_pwd_and_parents_for () {
    path_slashes=${PWD//[^\/]/}
    num_path_dirs="${#path_slashes}"
    path="$PWD"

    for (( n=${num_path_dirs}; n>0; --n )) do
      test -e "$path/$1" &&
        ORIG_OLDPWD="$OLDPWD" &&
        pushd "$path" > /dev/null &&
        PWD_AND_PARENTS_SEARCH_RESULT="$PWD/$1" &&
        popd > /dev/null &&
        OLDPWD="$ORIG_OLDPWD" &&
        return

      path="$path/.."
    done
  }

  deactivate_current_version_env () {
    path_remove "$RB_RUBIES_DIR/$RB_RUBY_VERSION/bin"
    path_remove "$RB_RUBIES_DIR/$RB_RUBY_VERSION/lib/ruby/gems/bin"
    unset_env_var GEM_PATH
    unset_env_var GEM_HOME
    set_env_var RB_RUBY_VERSION "$VERSION"
    set_env_var RB_RUBY_SOURCE "$SOURCE"
  }

  activate_new_version_env () {
    set_env_var RB_RUBY_SOURCE "$SOURCE"
    set_env_var RB_RUBY_VERSION "$VERSION"
    set_env_var GEM_HOME "$RB_RUBIES_DIR/$RB_RUBY_VERSION/lib/ruby/gems"
    set_env_var GEM_PATH "$RB_RUBIES_DIR/$RB_RUBY_VERSION/lib/ruby/gems"
    path_prepend "$RB_RUBIES_DIR/$RB_RUBY_VERSION/lib/ruby/gems/bin"
    path_prepend "$RB_RUBIES_DIR/$RB_RUBY_VERSION/bin"
  }

  reset_to_version_env () {
    if [ ! -e "$RB_RUBIES_DIR/$VERSION" ]; then
      warn "$VERSION was requested ($SOURCE)."
      warn "It is not installed - install it with ruby-build like this:\n"
      warn "ruby-build $VERSION $RB_RUBIES_DIR/$VERSION"
      return 1
    fi

    deactivate_current_version_env
    activate_new_version_env
    MSG="Activated $VERSION"
  }

  reset_to_system_env () {
    deactivate_current_version_env
    MSG="Activated system `ruby -v`"
  }

  read_version_from_file () {
    if [ -f "$1" ]; then SOURCE="from $1"; VERSION=`head -n 1 $1`; fi;
  }

  read_version_as_system () {
    SOURCE="no version requested"; VERSION="system"
  }

  # action methods

  get_version_and_command_from_params_and_version_files () {
    # get explicit version parameter
    if [[ $1 =~ ^@ ]]; then
      SOURCE="from command line"
      VERSION=$1; shift
      VERSION=${VERSION:1}
    fi
    # get command parameter
    COMMAND="$@"

    # fallback to searching pwd and its parents for a .ruby-version file
    search_pwd_and_parents_for "$RB_VERSION_FILE"
    [ -n "$VERSION" ] || read_version_from_file "$PWD_AND_PARENTS_SEARCH_RESULT"

    # fallback to the $HOME/.ruby-version, if present
    [ -n "$VERSION" ] || read_version_from_file "$HOME/$RB_VERSION_FILE"

    # fallback to the system version
    [ -n "$VERSION" ] || read_version_as_system
  }

  set_env_to_requested_version () {
    if [ "$SOURCE" != "$RB_RUBY_SOURCE" ] || [ -n "$COMMAND" ]; then
      if [[ "$VERSION" == "system" ]]; then
        reset_to_system_env
      else
        reset_to_version_env
      fi
    fi
  }

  get_version_and_command_from_params_and_version_files "$@"
  set_env_to_requested_version

  # output the info msg, if present
  if [ ! -z "$MSG" ]; then info "$MSG ($SOURCE)"; fi;

  # execute the command, if given
  [ -n "$COMMAND" ] && eval $COMMAND
}

# CLI

if [ "$1" = "--help" ]; then

  cat <<USAGE
The Ruby Auto Activator (release $RB_RELEASE)
~~ Manage Multiple Rubies ~~

  Usage:
    rb [@<version>] [command]"
    rb --init [--auto]"
    rb --help"
    rb --version

  More Info:
    https://github.com/rootedwest/rb
USAGE
  exit 0

elif [ "$1" = "--version" ]; then

  echo "$RB_RELEASE"
  exit 0

elif [ "$1" = "--init" ]; then

  # init code (to be run from shell startup script)
  # ie. eval "$(rb --init)"

  cat <<BASH_TAB_COMPLETION
if command -v complete >/dev/null 2>&1; then
  _rb_complete_version() {
    if [ -d "$RB_RUBIES_DIR" ]; then
      cur="\${COMP_WORDS[COMP_CWORD]}"
      opts=\$(\\ls -1 $RB_RUBIES_DIR | sed -e "s/^/@/")

      if [[ \$COMP_CWORD == 1 ]]; then
        COMPREPLY=( \$(compgen -W "\${opts} @system --init --help --version" -- \${cur}) )
        return 0
      fi

      if [[ \$COMP_CWORD == 2 ]]; then
        COMPREPLY=( \$(compgen -W "--auto" -- \${cur}) )
        return 0
      fi
    fi
  }
  complete -o nospace -F _rb_complete_version rb
fi
BASH_TAB_COMPLETION

  if [ "$2" = "--auto" ]; then

    # more init code - to be used in conjunction with the `--init` flag
    # ie. eval "$(rb --init --auto)"
    # (optional) auto mode (update ruby version as you change directories)

    cat <<AUTO_MODE
function cd() {
  builtin cd "\$@" && _rb_activate
}
source rb
AUTO_MODE
  fi

  exit 0

else
  _rb_activate $@
fi
